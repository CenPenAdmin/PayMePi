<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Payment Test</title>
    <!-- Configuration -->
    <script src="config.js"></script>
    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        header {
      background-color: #030006;
      padding: 20px 0;
    }

    header h1 {
      margin: 0;
      font-size: 3.5em;
      color: white;
      text-align: center;
    }
    </style>
</head>
<body>

    <!-- BANNER -->
     <header>
    <h1>Subscribe to Appraisells</h1>
    </header>
    <div style="text-align: center; padding: 20px; margin: 20px; background: #f8f9fa; border-radius: 8px;">
        <h2 style="color: #030006;">30-Day Subscription</h2>
        <p style="font-size: 1.1em; margin: 10px 0;">Get unlimited access to all non-appraised auctions for 30 days</p>
        <p style="font-size: 1em; color: #666;">✓ Browse all auction items<br>✓ Place bids on items<br>✓ Participate in live auctions</p>
        <p style="font-size: 1.2em; font-weight: bold; color: #030006;">Only 1 Pi Coin</p>
    </div>
    
    <!-- Pi Authentication Button (hidden by default since user is already authenticated) -->
    <button id="signinButton" onclick="signIn()" style="display: none;">Click To Allow Payment Creation</button>



    <div id="paymentSection" style="display: none;">
        <p id="userInfo">Loading user information...</p>
        <button id="payButton" onclick="makePayment()" style="padding: 15px 30px; font-size: 1.2em; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 20px 0;">Pay 1 Pi for 30-Day Subscription</button>
        <p id="paymentStatus"></p>
        <div id="debugInfo" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px;">
            <strong>Debug Information:</strong><br>
            <div id="debugContent"></div>
        </div>
    </div>

     <!-- Test Backend Connection -->
    <button onclick="testBackend()" style="background: #007bff; color: white; padding: 10px; margin: 10px;">
        Test Backend Connection
    </button>

    <script>
        let piUser = null;
        
        // Debug function
        function addDebugInfo(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
            console.log(`[DEBUG] ${message}`);
        }
        
        // Initialize Pi SDK
        addDebugInfo('Initializing Pi SDK...');
        
        // Check if Pi SDK loaded properly
        if (typeof Pi === 'undefined') {
            addDebugInfo('❌ Pi SDK not loaded! Make sure you are using Pi Browser.');
            alert('Error: Pi SDK not detected. Please open this app in Pi Browser.');
        } else {
            addDebugInfo('✅ Pi SDK loaded successfully');
            
            Pi.init({
                version: CONFIG.PI_SDK.version,
                sandbox: CONFIG.PI_SDK.sandbox
            });
            addDebugInfo(`Pi SDK initialized - Version: ${CONFIG.PI_SDK.version}, Sandbox: ${CONFIG.PI_SDK.sandbox}`);
        }
        
        addDebugInfo(`Backend URL: ${CONFIG.BACKEND_URL}`);
        
        // Check browser environment
        const userAgent = navigator.userAgent;
        addDebugInfo(`Browser: ${userAgent}`);
        
        if (userAgent.includes('Pi Browser') || userAgent.includes('iPhone')) {
            addDebugInfo('✅ Pi Browser detected');
        } else {
            addDebugInfo('⚠️ Not Pi Browser - authentication may not work');
        }

        // Test backend connection
        async function testBackend() {
            addDebugInfo('=== BACKEND CONNECTION TEST ===');
            
            // Test 1: Simple test endpoint (no CORS restrictions)
            try {
                addDebugInfo('Test 1: Simple endpoint (no CORS)...');
                
                const response1 = await fetch(`${CONFIG.BACKEND_URL}/simple-test`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response1.ok) {
                    const result1 = await response1.json();
                    addDebugInfo(`✅ Simple test successful: ${result1.message}`);
                } else {
                    addDebugInfo(`❌ Simple test failed: ${response1.status} ${response1.statusText}`);
                }
                
            } catch (error) {
                addDebugInfo(`❌ Simple test error: ${error.message}`);
            }
            
            // Test 2: Health endpoint with CORS
            try {
                addDebugInfo('Test 2: Health endpoint (with CORS)...');
                
                const response2 = await fetch(`${CONFIG.BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response2.ok) {
                    const result2 = await response2.json();
                    addDebugInfo(`✅ Health test successful: ${result2.status}`);
                } else {
                    addDebugInfo(`❌ Health test failed: ${response2.status} ${response2.statusText}`);
                }
                
            } catch (error) {
                addDebugInfo(`❌ Health test error: ${error.message}`);
            }
            
            // Test 3: CORS test endpoint
            try {
                addDebugInfo('Test 3: CORS test endpoint...');
                
                const response3 = await fetch(`${CONFIG.BACKEND_URL}/test-cors`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response3.ok) {
                    const result3 = await response3.json();
                    addDebugInfo(`✅ CORS test successful: ${result3.message}`);
                } else {
                    addDebugInfo(`❌ CORS test failed: ${response3.status} ${response3.statusText}`);
                }
                
            } catch (error) {
                addDebugInfo(`❌ CORS test error: ${error.message}`);
            }
            
            addDebugInfo('=== TEST COMPLETE - Check results above ===');
        }

        // Load user credentials from URL parameters (passed from profile.html)
        function loadUserFromParams() {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');
            const wallet = params.get('wallet');
            
            if (username) {
                // User credentials available from profile.html
                piUser = {
                    username: username,
                    wallet: wallet,
                    uid: 'from_profile' // We'll get the real UID if needed
                };
                
                addDebugInfo(`✅ User loaded from profile: ${username}`);
                
                // Update UI with user information
                document.getElementById('userInfo').innerHTML = `
                    <strong>Welcome, ${piUser.username}!</strong><br>
                    ${wallet ? `<small>Wallet: ${wallet}</small>` : ''}
                `;
                
                // Show payment section since user is authenticated
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('signinButton').style.display = 'none';
                
                addDebugInfo('Payment section ready - user authenticated from profile');
                return true;
            } else {
                addDebugInfo('⚠️ No user credentials in URL - showing sign in button');
                // Show sign in button if no credentials
                document.getElementById('signinButton').style.display = 'block';
                document.getElementById('paymentSection').style.display = 'none';
                return false;
            }
        }

        // Initialize page - try to load user from URL params first
        window.addEventListener('load', function() {
            addDebugInfo('Page loaded - checking for user credentials...');
            
            if (!loadUserFromParams()) {
                addDebugInfo('User not pre-authenticated - sign in required');
            }
        });

        // Sign in function (only used if user wasn't pre-authenticated)
        async function signIn() {
            try {
                addDebugInfo('Starting Pi authentication...');
                addDebugInfo('Checking Pi SDK availability...');
                
                // Check if Pi SDK is available
                if (typeof Pi === 'undefined') {
                    throw new Error('Pi SDK not loaded. Make sure you are using Pi Browser.');
                }
                
                addDebugInfo('Pi SDK detected. Checking Pi Browser environment...');
                
                // Check if we're in Pi Browser
                const userAgent = navigator.userAgent;
                addDebugInfo(`User Agent: ${userAgent}`);
                
                if (!userAgent.includes('Pi Browser') && !userAgent.includes('iPhone')) {
                    addDebugInfo('⚠️ Warning: Not detected as Pi Browser. This may cause issues.');
                }
                
                addDebugInfo('Attempting Pi.authenticate...');
                
                // Authenticate user with required scopes
                const auth = await Pi.authenticate([
                    'username', 
                    'payments'
                ], onIncompletePaymentFound);
                
                piUser = auth.user;
                addDebugInfo(`Authentication successful! User: ${piUser.username}`);
                addDebugInfo(`User UID: ${piUser.uid}`);
                console.log('Full auth object:', auth);
                console.log('User object:', piUser);
                
                // Log authentication to backend
                try {
                    await fetch(`${CONFIG.BACKEND_URL}/log-auth`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: piUser.username,
                            userUid: piUser.uid,
                            authSuccess: true
                        })
                    });
                    addDebugInfo('Authentication logged to database');
                } catch (logError) {
                    addDebugInfo(`Failed to log authentication: ${logError.message}`);
                }
                
                // Update UI with user information
                document.getElementById('userInfo').innerHTML = `
                    <strong>Welcome, ${piUser.username}!</strong><br>
                    <small>UID: ${piUser.uid}</small>
                `;
                
                // Hide sign in button and show payment section
                document.getElementById('signinButton').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'block';
                
                addDebugInfo('UI updated - ready for payments');
                
            } catch (error) {
                addDebugInfo(`Authentication failed: ${error.message}`);
                console.error('Authentication failed:', error);
                
                // More specific error handling
                if (error.message.includes('Pi SDK not loaded')) {
                    alert('Error: This app must be opened in Pi Browser. Please copy the URL and open it in Pi Browser app.');
                } else if (error.message.includes('User denied')) {
                    alert('Pi authentication was denied. Please try again and allow access.');
                } else if (error.message.includes('Not available')) {
                    alert('Pi authentication not available. Make sure you are signed into Pi Browser and have developer mode enabled.');
                } else {
                    alert('Sign in failed: ' + error.message + '\n\nTips:\n1. Make sure you are using Pi Browser\n2. Enable Developer/Sandbox mode\n3. Clear Pi Browser cache and try again');
                }
                throw error; // Re-throw for makePayment function
            }
        }

        // Payment function
        async function makePayment() {
            // If piUser doesn't have full Pi authentication, we need to authenticate first
            if (!piUser || piUser.uid === 'from_profile') {
                addDebugInfo('Need full Pi authentication for payment...');
                try {
                    await signIn();
                    if (!piUser) {
                        alert('Please sign in first');
                        return;
                    }
                } catch (error) {
                    alert('Authentication required for payment: ' + error.message);
                    return;
                }
            }

            addDebugInfo(`Creating payment for user: ${piUser.username}`);
            document.getElementById('paymentStatus').innerText = 'Creating payment...';

            try {
                // Create subscription payment
                const payment = await Pi.createPayment({
                    amount: 1, // 1 Pi for subscription
                    memo: "30-day subscription to Appraisells non-appraised auctions",
                    metadata: { 
                        orderId: Date.now().toString(),
                        paymentType: "monthly_subscription",
                        subscriptionDuration: "30_days",
                        itemName: "30-Day Auction Access Subscription",
                        description: "Monthly subscription to non-appraised auctions",
                        username: piUser.username,
                        uid: piUser.uid
                    }
                }, {
                    onReadyForServerApproval: function(paymentId) {
                        addDebugInfo(`Payment ready for server approval: ${paymentId}`);
                        console.log('Payment ready for approval:', paymentId);
                        document.getElementById('paymentStatus').innerText = 'Payment initiated. Approving...';
                        
                        // Send to your server for approval
                        approvePayment(paymentId);
                    },
                    onReadyForServerCompletion: function(paymentId, txId) {
                        addDebugInfo(`Payment ready for completion: ${paymentId}, TX: ${txId}`);
                        console.log('Payment ready for completion:', paymentId, txId);
                        document.getElementById('paymentStatus').innerText = 'Payment processing...';
                        
                        // Send to your server for completion
                        completePayment(paymentId, txId);
                    },
                    onCancel: function(paymentId) {
                        addDebugInfo(`Payment cancelled: ${paymentId}`);
                        console.log('Payment cancelled:', paymentId);
                        document.getElementById('paymentStatus').innerText = 'Payment cancelled';
                    },
                    onError: function(error, payment) {
                        addDebugInfo(`Payment error: ${error.message}`);
                        console.error('Payment error:', error);
                        document.getElementById('paymentStatus').innerText = 'Payment failed: ' + error.message;
                    }
                });

                addDebugInfo(`Payment created successfully: ${payment.identifier}`);
                console.log('Payment created:', payment);
                document.getElementById('paymentStatus').innerText = 'Payment initiated...';

            } catch (error) {
                addDebugInfo(`Payment creation failed: ${error.message}`);
                console.error('Payment creation failed:', error);
                document.getElementById('paymentStatus').innerText = 'Payment failed: ' + error.message;
            }
        }

        // Handle incomplete payments (required callback)
        function onIncompletePaymentFound(payment) {
            console.log('Incomplete payment found:', payment);
            // Handle incomplete payment if needed
        }

        // Approve payment on server
        async function approvePayment(paymentId) {
            try {
                addDebugInfo(`Sending approval request to backend: ${paymentId}`);
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/approve-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true' // Skip ngrok browser warning
                    },
                    body: JSON.stringify({ paymentId })
                });

                addDebugInfo(`Backend approval response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addDebugInfo(`Payment approval result: ${JSON.stringify(result)}`);
                console.log('Payment approval result:', result);
                
            } catch (error) {
                addDebugInfo(`Payment approval failed: ${error.message}`);
                console.error('Payment approval failed:', error);
                document.getElementById('paymentStatus').innerText = 'Payment approval failed: ' + error.message;
            }
        }

        // Complete payment on server
        async function completePayment(paymentId, txId) {
            try {
                addDebugInfo(`Sending completion request to backend: ${paymentId}, TX: ${txId}`);
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/complete-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true' // Skip ngrok browser warning
                    },
                    body: JSON.stringify({ paymentId, txId })
                });

                addDebugInfo(`Backend completion response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addDebugInfo(`Payment completion result: ${JSON.stringify(result)}`);
                console.log('Payment completion result:', result);
                
                if (result.success) {
                    // Show subscription success message
                    const subscriptionEndDate = new Date();
                    subscriptionEndDate.setDate(subscriptionEndDate.getDate() + 30); // Add 30 days
                    
                    document.getElementById('paymentStatus').innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: #155724; margin: 0 0 10px 0;">🎉 Subscription Activated!</h3>
                            <p style="margin: 5px 0;">Your 30-day subscription is now active.</p>
                            <p style="margin: 5px 0;"><strong>Access until:</strong> ${subscriptionEndDate.toLocaleDateString()}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;">You can now bid on all non-appraised auctions!</p>
                            <button onclick="window.location.href='profile.html?username=${encodeURIComponent(piUser.username)}${piUser.wallet ? '&wallet=' + encodeURIComponent(piUser.wallet) : ''}'" 
                                    style="margin-top: 10px; padding: 10px 20px; background: #030006; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Return to Profile
                            </button>
                        </div>
                    `;
                    addDebugInfo('🎉 SUBSCRIPTION ACTIVATED!');
                } else {
                    document.getElementById('paymentStatus').innerText = 'Subscription activation failed';
                    addDebugInfo('❌ Subscription activation failed');
                }
                
            } catch (error) {
                addDebugInfo(`Payment completion failed: ${error.message}`);
                console.error('Payment completion failed:', error);
                document.getElementById('paymentStatus').innerText = 'Payment completion failed: ' + error.message;
            }
        }
    </script>
</body>
</html>
