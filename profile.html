<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile</title>
  
  <!-- Configuration -->
  <script src="config.js"></script>
  
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
  
  header {
      background-color: #030006;
      padding: 20px 0;
    }

    header h1 {
      margin: 0;
      font-size: 3.5em;
      color: white;
      text-align: center;
    }

    body { 
      background-color: white;
    }
  
    /* Force subscription state display */
    .subscription-active {
      display: block !important;
      visibility: visible !important;
    }
    
    .subscription-hidden {
      display: none !important;
      visibility: hidden !important;
    }
  
  </style>
 
</head>
<body>
  
  <header>
  <h1>APPRAISELLS</h1>
  </header> 
  <div id="userInfo" style="margin: 30px 0; font-size: 1.2em;"></div>
  <div id="walletInfo" style="margin: 10px 0; font-size: 1.1em;"></div>

  <!-- Subscription Status Text (hidden by default) -->
  <div id="subscriptionText" style="display: none; text-align: center; margin: 20px 0; font-size: 1.2em; color: #030006; font-weight: 500;">
    Enjoy Appraisells auctions
  </div>

  <!-- Subscribe Button (shown only if no active subscription) -->
  <div id="subscribeSection" style="text-align: center; margin: 20px 0;">
    <button onclick="subscribe()" id="subscribeBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Subscribe</button>
  </div>

  <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 40vh; cursor:pointer;" onclick="window.location.href='auctionPayment.html'">
    <span style="font-size:1.5em; color: white; margin-bottom:16px;">Auction 1 Date and Time</span>
    <img src="images/auction-kurt-cobain-item1.jpg" alt="Appraisal" style="height:240px; width:240px; object-fit:cover; border:1px solid #fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
  </div>
  
  <div style="text-align: center; margin-top: 100px;">
    <button onclick="logout()" id="logoutBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Log Out</button>
  </div>

  

  <script>
    let piUser = null; // Will hold the authenticated Pi user
    

    function logout() {
      window.location.href = "index.html";
    }

    function displayWalletInfo(wallet) {
      // Display wallet information if available
      const walletElement = document.getElementById("walletInfo");
      if (walletElement) {
        walletElement.innerHTML = wallet 
          ? `<strong>Wallet:</strong> ${wallet}`
          : "";
      }
    }

    function subscribe() {
      // Use authenticated Pi user for subscription
      if (!piUser) {
        alert('Please authenticate with Pi Network first');
        return;
      }
      
      // Redirect to auctionPayment.html with Pi user parameters
      let redirectUrl = "auctionPayment.html";
      redirectUrl += `?username=${encodeURIComponent(piUser.username)}`;
      if (piUser.wallet) {
        redirectUrl += `&wallet=${encodeURIComponent(piUser.wallet)}`;
      }
      window.location.href = redirectUrl;
    }

    // Authenticate with Pi Network and load user profile
    async function authenticateAndLoadProfile() {
      try {
        console.log('üîê Starting Pi Network authentication...');
        
        // Check if Pi SDK is available
        if (typeof Pi === 'undefined') {
          throw new Error('Pi SDK not loaded. Please open this app in Pi Browser.');
        }
        
        // Initialize Pi SDK
        Pi.init({
          version: "2.0",
          sandbox: true
        });
        
        console.log('üîê Pi SDK initialized, authenticating user...');
        
        // Authenticate user with Pi Network
        const auth = await Pi.authenticate(['username', 'payments']);
        piUser = auth.user;
        
        console.log(`‚úÖ Pi Network authentication successful! User: ${piUser.username}`);
        console.log('Full Pi user object:', piUser);
        
        // Display user information
        document.getElementById("userInfo").innerHTML = `<strong>Username:</strong> ${piUser.username}`;
        displayWalletInfo(piUser.wallet);
        
        // Create/update user profile in backend
        await createUserProfileIfNeeded(piUser.username, piUser.wallet, piUser.uid);
        
        // Check subscription status for authenticated user
        await checkSubscriptionStatus(piUser.username);
        
      } catch (error) {
        console.error('‚ùå Pi Network authentication failed:', error);
        
        // Show error message to user
        document.getElementById("userInfo").innerHTML = `
          <div style="color: red; text-align: center; margin: 20px;">
            <strong>Authentication Required</strong><br>
            Please open this app in Pi Browser and allow authentication.
          </div>
        `;
        
        // Hide both subscription elements and show login prompt
        document.getElementById('subscriptionText').style.display = 'none';
        document.getElementById('subscribeSection').innerHTML = `
          <div style="text-align: center; margin: 20px 0;">
            <button onclick="authenticateAndLoadProfile()" style="padding:12px 25px; font-size:1.5rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">
              Login with Pi Network
            </button>
          </div>
        `;
      }
    }

    // Create user profile in backend if it doesn't exist
    async function createUserProfileIfNeeded(username, wallet, userUid) {
      try {
        console.log(`üîÑ Ensuring user profile exists for: ${username}`);
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/create-user-profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify({
            username: username,
            wallet: wallet,
            userUid: userUid
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log(`‚úÖ User profile ready for: ${username}`);
        } else {
          console.warn(`‚ö†Ô∏è Profile creation failed for ${username}:`, result.error);
        }
        
      } catch (error) {
        console.error('‚ùå Failed to create user profile:', error);
        // Don't block subscription checking if this fails
      }
    }

    // Check subscription status and update UI
    async function checkSubscriptionStatus(username) {
      try {
        console.log(`üîç Starting subscription check for: ${username}`);
        
        // Add cache busting to ensure fresh data
        const timestamp = Date.now();
        const url = `${CONFIG.BACKEND_URL}/subscription-status/${username}?t=${timestamp}`;
        console.log(`üì° Fetching from: ${url}`);
        
        const response = await fetch(url, {
          headers: {
            'ngrok-skip-browser-warning': 'true',
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        console.log(`üì¨ Response status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log(`üìä Full subscription result:`, result);
        console.log(`üîç result.success: ${result.success}`);
        console.log(`üîç result.subscribed: ${result.subscribed}`);
        
        if (result.success && result.subscribed) {
          // User has active subscription - show simple text, hide subscribe button
          console.log(`‚úÖ ${username} HAS active subscription - showing subscription text`);
          console.log(`üéØ BEFORE UI UPDATE:`);
          console.log(`   - subscriptionText display: ${document.getElementById('subscriptionText')?.style.display}`);
          console.log(`   - subscribeSection display: ${document.getElementById('subscribeSection')?.style.display}`);
          
          // Force update the UI
          const subscriptionTextElement = document.getElementById('subscriptionText');
          const subscribeSectionElement = document.getElementById('subscribeSection');
          
          if (subscriptionTextElement && subscribeSectionElement) {
            subscriptionTextElement.style.display = 'block';
            subscriptionTextElement.style.visibility = 'visible';
            subscribeSectionElement.style.display = 'none';
            subscribeSectionElement.style.visibility = 'hidden';
            
            // Add CSS classes for extra enforcement
            subscriptionTextElement.className = 'subscription-active';
            subscribeSectionElement.className = 'subscription-hidden';
            
            console.log(`üéØ AFTER UI UPDATE:`);
            console.log(`   - subscriptionText display: ${subscriptionTextElement.style.display}`);
            console.log(`   - subscribeSection display: ${subscribeSectionElement.style.display}`);
            console.log(`‚úÖ UI SUCCESSFULLY UPDATED - SHOULD SHOW "Enjoy Appraisells auctions"`);
          } else {
            console.error(`‚ùå CRITICAL ERROR: DOM elements not found!`);
            console.error(`   - subscriptionText element: ${subscriptionTextElement}`);
            console.error(`   - subscribeSection element: ${subscribeSectionElement}`);
          }
        } else {
          // User has no active subscription - show subscribe button, hide subscription text
          console.log(`‚ùå ${username} has NO active subscription - showing subscribe button`);
          console.log(`üìã Subscription details:`, result);
          document.getElementById('subscriptionText').style.display = 'none';
          document.getElementById('subscribeSection').style.display = 'block';
          console.log(`üéØ UI Updated: subscribeSection visible, subscriptionText hidden`);
        }
        
        // Double-check the DOM elements
        const subscriptionTextElement = document.getElementById('subscriptionText');
        const subscribeSectionElement = document.getElementById('subscribeSection');
        console.log(`üîç DOM Check - subscriptionText display: ${subscriptionTextElement?.style.display}`);
        console.log(`üîç DOM Check - subscribeSection display: ${subscribeSectionElement?.style.display}`);
        
      } catch (error) {
        console.error('‚ùå Failed to check subscription status:', error);
        // On error, show subscribe button (safe default)
        document.getElementById('subscriptionText').style.display = 'none';
        document.getElementById('subscribeSection').style.display = 'block';
        console.log(`‚ö†Ô∏è Error occurred - defaulting to showing subscribe button`);
      }
    }

    // Initialize page with Pi Network authentication
    window.addEventListener('load', function() {
      console.log('üîÑ Profile page loaded - starting Pi Network authentication...');
      
      // Hide both elements initially
      document.getElementById('subscriptionText').style.display = 'none';
      document.getElementById('subscribeSection').style.display = 'none';
      
      // Start Pi Network authentication
      authenticateAndLoadProfile();
    });

   

  </script>

  </body>

  </html>
