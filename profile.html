<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile</title>
  
  <!-- Configuration -->
  <script src="config.js"></script>

  <style>
  
  header {
      background-color: #030006;
      padding: 20px 0;
    }

    header h1 {
      margin: 0;
      font-size: 3.5em;
      color: white;
      text-align: center;
    }

    body { 
      background-color: white;
    }
  
  </style>
 
</head>
<body>
  
  <header>
  <h1>APPRAISELLS</h1>
  </header> 
  <div id="userInfo" style="margin: 30px 0; font-size: 1.2em;"></div>
  <div id="walletInfo" style="margin: 10px 0; font-size: 1.1em;"></div>

  <!-- Subscription Status Banner (hidden by default) -->
  <div id="subscriptionBanner" style="display: none; text-align: center; margin: 20px; padding: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <div style="font-size: 1.1em; font-weight: bold;">üéâ Please enjoy Appraisells auctions</div>
    <div id="subscriptionCountdown" style="margin-top: 8px; font-size: 1em;">Subscription valid until: <span id="subscriptionExpiry"></span></div>
    <div id="daysRemaining" style="margin-top: 5px; font-size: 0.9em; opacity: 0.9;"></div>
  </div>

  <!-- Subscribe Button (shown only if no active subscription) -->
  <div id="subscribeSection" style="text-align: center; margin: 20px 0;">
    <button onclick="subscribe()" id="subscribeBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Subscribe</button>
  </div>

  <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 40vh; cursor:pointer;" onclick="window.location.href='auctionPayment.html'">
    <span style="font-size:1.5em; color: white; margin-bottom:16px;">Auction 1 Date and Time</span>
    <img src="images/auction-kurt-cobain-item1.jpg" alt="Appraisal" style="height:240px; width:240px; object-fit:cover; border:1px solid #fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
  </div>
  
  <div style="text-align: center; margin-top: 100px;">
    <button onclick="logout()" id="logoutBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Log Out</button>
  </div>

  

  <script>
    

    function logout() {
      window.location.href = "index.html";
    }

    function subscribe() {
      // Get current user parameters
      const params = new URLSearchParams(window.location.search);
      const username = params.get("username");
      const wallet = params.get("wallet");
      
      // Redirect to auctionPayment.html with user parameters
      let redirectUrl = "auctionPayment.html";
      if (username) {
        redirectUrl += `?username=${encodeURIComponent(username)}`;
        if (wallet) {
          redirectUrl += `&wallet=${encodeURIComponent(wallet)}`;
        }
      }
      window.location.href = redirectUrl;
    }



    // Display Pi user info from query params
    function displayPiUserInfo() {
      const params = new URLSearchParams(window.location.search);
      const username = params.get("username");
      const wallet = params.get("wallet");
      document.getElementById("userInfo").innerHTML = username
        ? `<strong>Username:</strong> ${username}`
        : "";
      displayWalletInfo(wallet);
      
      // Check subscription status after displaying user info
      if (username) {
        checkSubscriptionStatus(username);
      }
    }

    // Check subscription status and update UI
    async function checkSubscriptionStatus(username) {
      try {
        console.log(`Checking subscription status for: ${username}`);
        
        // Add cache busting to ensure fresh data
        const timestamp = Date.now();
        const response = await fetch(`${CONFIG.BACKEND_URL}/subscription-status/${username}?t=${timestamp}`, {
          headers: {
            'ngrok-skip-browser-warning': 'true',
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        const result = await response.json();
        
        console.log('Subscription status:', result);
        
        if (result.success && result.subscribed) {
          // User has active subscription - show banner, hide subscribe button
          showSubscriptionBanner(result);
          document.getElementById('subscribeSection').style.display = 'none';
        } else {
          // User has no active subscription - show subscribe button, hide banner
          document.getElementById('subscriptionBanner').style.display = 'none';
          document.getElementById('subscribeSection').style.display = 'block';
        }
        
      } catch (error) {
        console.error('Failed to check subscription status:', error);
        // On error, show subscribe button (safe default)
        document.getElementById('subscriptionBanner').style.display = 'none';
        document.getElementById('subscribeSection').style.display = 'block';
      }
    }

    // Show subscription banner with countdown
    function showSubscriptionBanner(subscriptionData) {
      const banner = document.getElementById('subscriptionBanner');
      const expirySpan = document.getElementById('subscriptionExpiry');
      const daysSpan = document.getElementById('daysRemaining');
      
      // Parse expiry date
      const expiryDate = new Date(subscriptionData.endDate);
      const now = new Date();
      const daysRemaining = Math.max(0, subscriptionData.daysRemaining || 0);
      
      // Format expiry date
      const formattedDate = expiryDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      expirySpan.textContent = formattedDate;
      
      // Show days remaining with appropriate styling
      if (daysRemaining > 7) {
        daysSpan.innerHTML = `<span style="color: #ffffff;">üìÖ ${daysRemaining} days remaining</span>`;
      } else if (daysRemaining > 3) {
        daysSpan.innerHTML = `<span style="color: #fff3cd;">‚ö†Ô∏è ${daysRemaining} days remaining</span>`;
      } else if (daysRemaining > 0) {
        daysSpan.innerHTML = `<span style="color: #f8d7da;">üö® ${daysRemaining} days remaining</span>`;
      } else {
        daysSpan.innerHTML = `<span style="color: #f8d7da;">üö® Subscription expired</span>`;
      }
      
      banner.style.display = 'block';
      console.log(`Subscription banner shown: ${daysRemaining} days remaining`);
    }

    displayPiUserInfo();

   

  </script>

  </body>

  </html>
